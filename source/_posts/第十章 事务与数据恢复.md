---
title:  数据库原理第十章 数据库恢复技术
date: 2022-12-19 20:57:48
categories: 数据库系统原理
tags: [数据库]
---

## 事务的概念

想要学好这一章的恢复技术以及下一章的并发控制，首先需要了解这两个技术考虑的基本单位：事务（Transaction）

### 事务的定义

**事务**是数据库操作的序列，这些操作不可分割

事务不等于程序，一个程序往往有多个事务

事务在恢复和并发控制中是基本单位

#### 定义语法

事务可以显式定义，在一串SQL语句最后加上：

- COMMIT：表示事务结束、提交操作结果
- ROLLBACK：事务异常、回滚到事务执行前的状态

当然没有用上面的显示方法定义的话，系统会自动划分

### 事务的特性

概括为ACID：

- 原子性Atomicity：事务的操作要么全做、要么全不做
- 一致性Consistency：事务不能够运行到一半终止且不回滚
- 隔离性Isolation：并发事务互不干扰
- 持续性Durability：事务对DB的改变是永久性的，不会被其他操作或者故障干扰

## 数据库恢复概述

DBS在完整执行一个事务以后，会从一个一致状态（或正确状态）转变到另一个一致状态。而如果执行过程中发生了某些错误，就会导致DB停留在不一致的状态，**恢复的目的就是把DB从不一致状态恢复到一致状态。**

## 故障种类

### 事务内部故障

- 可预期故障：比如转账事务余额不足等，比较好解决，在程序里面ROLLBACK就行

- 不可预期故障：

  - 运算溢出
  - 并发死锁
  - 违法完整性

  这类故障较难考虑周到，没办法在程序里面写好处理

这时就需要DBMS强制ROLLBACK（UNDO处理）

### 系统故障

又叫软故障，整个系统都停止了运作，比如断电。此时执行的所有事物都异常终止了。

恢复策略：

- 对于部分已经写入物理数据库的事务：强行撤销回滚（UNDO）
- 对于已经完成但是没有COMMIT的事务：重做（REDO）

### 介质故障

硬盘寄了

### 计算机病毒

没啥好说的

### 小结

总的来说，数据库破坏分为两种：

- 数据库本身被破坏（介质故障、病毒）
- 数据不正确（事务故障、系统故障）

我们主要讨论第二种

主要使用**冗余**来帮助恢复和重建

## 恢复的实现技术

主要有转储、日志文件两种方法

### 数据转储

指定期的为整个数据库中的文件创建一个**后备副本**，遭到破坏以后需要重新装入，可以**恢复到转储时的状态**

如果想要将事务恢复到故障发生状态的话，还需要重新运行转储以后的所有事务

### 转储分类

#### 动态与静态

转储不是一个瞬间过程，需要持续一段时间，根据转储的时候是否可以继续操作DB分为动态和静态转储

**静态转储**实现很简单，但是降低了数据库的可用性

**动态转储**可用性更高，但是需要一定技术来保证副本是有效的，这时就需要用到**日志文件**，记录转储过程中又有一些什么操作

#### 海量和增量

熟悉手机刷机的对这个应该比较熟悉，海量更新就是每次都转储数据库的全部数据，增量更新就是只转储更新过的数据

### 日志文件

#### 日志的格式和内容

日志文件有以记录为单位的也有以块为单位的

**以记录为单位的日志文件：**

1. 事务开始的标记
2. 事务结束的标记
3. 事务包含的所有更新操作

**具体每条记录的内容：**

- 事务表示
- 操作类型
- 操作对象
- 旧值
- 新值

**以数据块为单位的日志文件：**

1. 事务标识
2. 更新前后的数据块

### 日志文件的作用

- 可以用于事务故障和系统故障的恢复
- 按照之前所说，可以协助后备副本恢复

### 登记日志文件

登记日志文件的时候需要严格遵守如下两条原则：

- 严格按照时间顺序等级
- 先写日志再写数据库

## 恢复策略

### 事务故障的恢复

直接UNDO即可：

1. 反向扫描日志文件
2. 对于事务的更新做反向操作

### 系统故障的恢复

系统故障导致的故障事务有两种：

- 未完成的事务
- 已经提交但是还留在buffer未写入数据库的事务（**有commit**）

对于第一条·未完成的事务，和上面一样UNDO即可

对于已完成在buffer中的事务，采用REDO做法

### 介质故障的恢复

1. 装入最近的副本
   - 静态的直接装
   - 动态的配合日志
2. redo副本完成-故障期间的事务

## 具有检查点的恢复技术

前面说的搜索日志实在是太费时间了，所以在日志文件中添加了检查点记录（check point）和一个重新开始文件，可以动态的维护日志

检查点的内容：

- 建立检查点时，正在执行的事务
- 这些事务最近日志记录的地址

重新开始文件的内容：

- 各个检查点记录在日志文件中的地址

可以理解为，检查点指向记录，重新开始文件指向检查点

### 利用检查点的恢复策略

![image-20221219203258683](E:\Blog\source\images\oneplusnameless\image-20221219203258683.png)

**只看完成时间，不看开始时间**

- 在检查点之前完成的：不用管
- 在检查点之后、系统故障之前完成的：重做
- 在故障时还没完成的：撤销

## 数据库镜像

数据库镜像是针对介质故障的方法

数据库会把其**全部或部分**复制一个镜像，DBMS会自动维护其一致性，出现故障的时候就可以使用镜像并从镜像恢复

一般来说只会对**关键数据和日志文件镜像**

## 总结

本章讲的是数据库在发生数据不一致或者错误之后的恢复技术，首先介绍了数据库恢复和并发控制的基本单位——事务，以及事务的ACID四大特性

考虑数据库的恢复，先要考虑数据库运行过程中可能的故障：事务内部故障、系统故障、介质故障和计算机病毒。本课程着重考察前两者。

数据库的恢复主要依靠两个技术——转储和日志。

转储，即把数据库复制一个后备副本，在需要的时候可以用副本来恢复。

转储根据是否可以在转储时工作分为动态和静态，同时还有海量和增量之分。动态转储需要配合日志使用。

日志有以记录为单位和以数据块为单位的，这里主要讨论以记录为单位的。日志可以单独用于恢复，也可以协助动态转储恢复。

记录日志的时候，一定要先写日志再写数据库。

对于事务故障，一般采用UNDO也就是系统强制ROLLBACK

对于系统故障，一般根据事务是执行到一半被终止还是执行完了在buffer没来得及写入。前者和事务故障一样需要UNDO、后者需要REDO。

介质故障必须要日志+转储强制使用。

检查点其实是日志的一种升级，检查点记录了当前事务和事务最近活动的记录位置，可以方便查找事务，而所有的检查点又被存到了重新开始文件中。

数据库镜像主要是针对介质故障的，镜像可以是部分关键数据和日志文件的，在从镜像恢复数据库的过程中，镜像可以运行开保障数据库的可用性。

