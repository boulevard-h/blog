---
title: SQL连接
date: 2022-10-02 20:52:58
categories: 数据库原理
tags: [数据库原理, mysql]
---

## 前言

MySQL前面的基本语法都还暂时还行，连接这块的东西稍微有点多，所以整理一下。算是复习前面关系代数的连接，也是熟悉一下MySQL语法。

使用经典的S-T Schema当作例子吧，三个表如下：

S-T.Student

```sql
+-----------+-------+------+------+-------+
| Sno       | Sname | Ssex | Sage | Sdept |
+-----------+-------+------+------+-------+
| 201215121 | 李勇  | 男   |   20 | CS    |
| 201215122 | 刘晨  | 女   |   19 | CS    |
| 201215123 | 王敏  | 女   |   18 | MA    |
| 201215125 | 张立  | 男   |   19 | IS    |
+-----------+-------+------+------+-------+
```

S-T.Course

```sql
+-----------+-----+-------+
| Sno       | Cno | Grade |
+-----------+-----+-------+
| 201215121 | 1   |    92 |
| 201215121 | 2   |    85 |
| 201215121 | 3   |    88 |
| 201215122 | 2   |    90 |
| 201215122 | 3   |    80 |
+-----------+-----+-------+
```

S-T.sc

```sql
+-----------+-----+-------+
| Sno       | Cno | Grade |
+-----------+-----+-------+
| 201215121 | 1   |    92 |
| 201215121 | 2   |    85 |
| 201215121 | 3   |    88 |
| 201215122 | 2   |    90 |
| 201215122 | 3   |    80 |
+-----------+-----+-------+
```

## 笛卡尔积

执行语句`SELECT * FROM Student, SC;`

出现结果如下，也就是Student$\cdot$SC笛卡尔积。

```sql
+-----------+-------+------+------+-------+-----------+-----+-------+
| Sno       | Sname | Ssex | Sage | Sdept | Sno       | Cno | Grade |
+-----------+-------+------+------+-------+-----------+-----+-------+
| 201215125 | 张立  | 男   |   19 | IS    | 201215121 | 1   |    92 |
| 201215123 | 王敏  | 女   |   18 | MA    | 201215121 | 1   |    92 |
| 201215122 | 刘晨  | 女   |   19 | CS    | 201215121 | 1   |    92 |
| 201215121 | 李勇  | 男   |   20 | CS    | 201215121 | 1   |    92 |
| 201215125 | 张立  | 男   |   19 | IS    | 201215121 | 2   |    85 |
| 201215123 | 王敏  | 女   |   18 | MA    | 201215121 | 2   |    85 |
| 201215122 | 刘晨  | 女   |   19 | CS    | 201215121 | 2   |    85 |
| 201215121 | 李勇  | 男   |   20 | CS    | 201215121 | 2   |    85 |
| 201215125 | 张立  | 男   |   19 | IS    | 201215121 | 3   |    88 |
| 201215123 | 王敏  | 女   |   18 | MA    | 201215121 | 3   |    88 |
| 201215122 | 刘晨  | 女   |   19 | CS    | 201215121 | 3   |    88 |
| 201215121 | 李勇  | 男   |   20 | CS    | 201215121 | 3   |    88 |
| 201215125 | 张立  | 男   |   19 | IS    | 201215122 | 2   |    90 |
| 201215123 | 王敏  | 女   |   18 | MA    | 201215122 | 2   |    90 |
| 201215122 | 刘晨  | 女   |   19 | CS    | 201215122 | 2   |    90 |
| 201215121 | 李勇  | 男   |   20 | CS    | 201215122 | 2   |    90 |
| 201215125 | 张立  | 男   |   19 | IS    | 201215122 | 3   |    80 |
| 201215123 | 王敏  | 女   |   18 | MA    | 201215122 | 3   |    80 |
| 201215122 | 刘晨  | 女   |   19 | CS    | 201215122 | 3   |    80 |
| 201215121 | 李勇  | 男   |   20 | CS    | 201215122 | 3   |    80 |
+-----------+-------+------+------+-------+-----------+-----+-------+
```

## 等值连接与非等值连接

### 等值连接

对于Sno进行等值连接`SELECT * FROM Student, SC WHERE Student.Sno=SC.Sno;`

结果如下

```sql
+-----------+-------+------+------+-------+-----------+-----+-------+
| Sno       | Sname | Ssex | Sage | Sdept | Sno       | Cno | Grade |
+-----------+-------+------+------+-------+-----------+-----+-------+
| 201215121 | 李勇  | 男   |   20 | CS    | 201215121 | 1   |    92 |
| 201215121 | 李勇  | 男   |   20 | CS    | 201215121 | 2   |    85 |
| 201215121 | 李勇  | 男   |   20 | CS    | 201215121 | 3   |    88 |
| 201215122 | 刘晨  | 女   |   19 | CS    | 201215122 | 2   |    90 |
| 201215122 | 刘晨  | 女   |   19 | CS    | 201215122 | 3   |    80 |
+-----------+-------+------+------+-------+-----------+-----+-------+
```

#### 自然连接

其实上面这个等值连接就是一个自然连接，但还是示范一下语法：

` SELECT * FROM Student NATURAL JOIN SC;`

结果毋庸置疑和上面一样，就不复制粘贴了。

### 非等值连接

也是先笛卡尔积，后过滤，就不细说了。

## 过滤谓词

连接以后，还可以在WHERE中加入其他条件，称为过滤谓词，如：

```sql
mysql> SELECT * FROM Student, SC WHERE Student.Sno=SC.Sno AND SC.Grade > 85;
+-----------+-------+------+------+-------+-----------+-----+-------+
| Sno       | Sname | Ssex | Sage | Sdept | Sno       | Cno | Grade |
+-----------+-------+------+------+-------+-----------+-----+-------+
| 201215121 | 李勇  | 男   |   20 | CS    | 201215121 | 1   |    92 |
| 201215121 | 李勇  | 男   |   20 | CS    | 201215121 | 3   |    88 |
| 201215122 | 刘晨  | 女   |   19 | CS    | 201215122 | 2   |    90 |
```

## 自身连接

特殊的连接，一定要给表取别名，要不然就分不清，如：

```sql
 SELECT FIRST.Cno, SECOND.Cpno FROM Course FIRST, Course SECOND WHERE
FIRST.Cpno = SECOND.Cno;
+-----+------+
| Cno | Cpno |
+-----+------+
| 3   | 5    |
| 1   | 7    |
| 4   | NULL |
| 7   | NULL |
| 5   | 6    |
+-----+------+
5 rows in set (0.02 sec)
```

功能就是显示先修课的先修课（爷爷课是吧

## 外连接

这一块东西就比较乱了...

外连接可以是基于**ON**子句的：

```sql
mysql> SELECT * FROM Student LEFT OUTER JOIN SC ON (Student.Sno=SC.Sno);
+-----------+-------+------+------+-------+-----------+------+-------+
| Sno       | Sname | Ssex | Sage | Sdept | Sno       | Cno  | Grade |
+-----------+-------+------+------+-------+-----------+------+-------+
| 201215121 | 李勇  | 男   |   20 | CS    | 201215121 | 3    |    88 |
| 201215121 | 李勇  | 男   |   20 | CS    | 201215121 | 2    |    85 |
| 201215121 | 李勇  | 男   |   20 | CS    | 201215121 | 1    |    92 |
| 201215122 | 刘晨  | 女   |   19 | CS    | 201215122 | 3    |    80 |
| 201215122 | 刘晨  | 女   |   19 | CS    | 201215122 | 2    |    90 |
| 201215123 | 王敏  | 女   |   18 | MA    | NULL      | NULL |  NULL |
| 201215125 | 张立  | 男   |   19 | IS    | NULL      | NULL |  NULL |
+-----------+-------+------+------+-------+-----------+------+-------+
```

当然也可以用自然连接关键字：

``` sql
SELECT * FROM Student NATURAL LEFT OUTER JOIN SC;
```

结果一样。

### 关于ON和WHERE的区别

WHERE可以看作是先建立连接，然后对于条件筛选；

ON对于左边表中的任何一个元组x，无论右边表中存不存在一个元组y使得(x, y)满足ON条件，都至少会返回一个x元组，即：即使不应该返回任何(x, y)，也应该返回一个(x, NULL)

#### 示例

两个测试用的表：

``` sql
mysql> SELECT * FROM TestTable1;
+----+------+
| id | size |
+----+------+
|  1 |   10 |
|  2 |   20 |
|  3 |   30 |
+----+------+
```

``` sql
mysql> SELECT * FROM TestTable2;
+------+------+
| size | name |
+------+------+
|   10 | AAA  |
|   20 | BBB  |
|   30 | CCC  |
+------+------+
```

**如果用WHERE的话：**

```SQL
mysql> select * from testtable1 left join testtable2 on (testtable1.size = testtable2.size) where testtable2.name='AAA';
+----+------+------+------+
| id | size | size | name |
+----+------+------+------+
|  1 |   10 |   10 | AAA  |
+----+------+------+------+
```

**而用ON的话：**

``` sql
mysql> select * from testtable1 left join testtable2 on (testtable1.size = testtable2.size and testtable2.name = "AAA");
+----+------+------+------+
| id | size | size | name |
+----+------+------+------+
|  1 |   10 |   10 | AAA  |
|  2 |   20 | NULL | NULL |
|  3 |   30 | NULL | NULL |
+----+------+------+------+
```

**但是对于INNER JOIN来说，自然是不存在一边为NULL的元组的，所以ON的结果和WHERE的结果就还是一样的，它们的区别仅限于在外连接。**

## 多表连接

没啥好说的，上面会了这个就可以看作是多次连接再连接

## 关于SQL的连接类型：

SQL中有很多种连接

- INNER JOIN：内连接
- LEFT/RIGHT/FULL OUTER JOIN：三种外连接
- NATURAL JOIN：自然连接
- CROSS JOIN：笛卡尔积
- SELF JOIN：自链接

同一种连接也有很多的表达方式，在使用tableA xxx join tableB时候，还可以使用using(Col1,...,Coln)来选择具体需要使用哪些公共属性来连接。
